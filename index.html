<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfico con ECharts y Filtro por Año</title>
    <style>
        /* Ajusta el tamaño del contenedor */
        #main {
            width: 600px;
            height: 400px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <!-- Contenedor para el gráfico -->
    <div id="main"></div>

    <!-- Selector de año -->
    <label for="yearSelect">Selecciona el año:</label>
    <select id="yearSelect">
        <option value="all">Todos los años</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
    </select>

    <!-- Incluye la biblioteca ECharts desde la CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <script>
        // Datos con años, carreras, y otras variables
        var data = {
            '2022': [
                // Formato de los datos: [matriculados, empleabilidad, n_apariciones, n_iniciativas, nps, carrera]
                [500, 85, 50, 3, 4, 'Carrera A'],
                [700, 75, 80, 6, 5, 'Carrera B'],
                [900, 90, 100, 10, 7, 'Carrera C']
            ],
            '2023': [
                [600, 88, 60, 4, 6, 'Carrera A'],
                [800, 78, 70, 5, 5, 'Carrera B'],
                [1000, 92, 110, 11, 8, 'Carrera C']
            ],
            '2024': [
                [550, 83, 40, 3, 3, 'Carrera A'],
                [750, 79, 90, 7, 5, 'Carrera B'],
                [1050, 94, 120, 12, 9, 'Carrera C']
            ]
        };

        // Inicializar el gráfico en el div con id "main"
        var chart = echarts.init(document.getElementById('main'));

        // Función para combinar los datos de todos los años para una misma carrera
        function combineData() {
            var combinedData = {};

            // Recorre cada año
            for (var year in data) {
                var yearData = data[year];

                // Recorre cada carrera dentro de un año
                for (var i = 0; i < yearData.length; i++) {
                    var carrera = yearData[i][5];

                    if (!combinedData[carrera]) {
                        combinedData[carrera] = {
                            matriculados: 0,
                            empleabilidad: 0,
                            n_apariciones: 0,
                            n_iniciativas: 0,
                            nps: 0,
                            count: 0 // para calcular promedios
                        };
                    }

                    combinedData[carrera].matriculados += yearData[i][0];
                    combinedData[carrera].empleabilidad += yearData[i][1];
                    combinedData[carrera].n_apariciones += yearData[i][2];
                    combinedData[carrera].n_iniciativas += yearData[i][3];
                    combinedData[carrera].nps += yearData[i][4];
                    combinedData[carrera].count += 1; // Incrementamos el número de años para esta carrera
                }
            }

            // Ajustamos los promedios para las métricas que requieren promedio
            var finalData = [];
            for (var carrera in combinedData) {
                var item = combinedData[carrera];
                finalData.push([
                    item.matriculados,
                    (item.empleabilidad / item.count), // Promedio de empleabilidad
                    item.n_apariciones,
                    item.n_iniciativas,
                    (item.nps / item.count), // Promedio de NPS
                    carrera
                ]);
            }

            return finalData;
        }

        // Función para generar el gráfico basado en los datos del año seleccionado
        function updateChart(year) {
            var yearData = [];

            // Si se selecciona "Todos los años", combinamos y sumamos los datos de todos los años
            if (year === 'all') {
                yearData = combineData();
            } else {
                // Obtener datos para el año seleccionado
                yearData = data[year];
            }

            var option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        var data = params.data;
                        return `
                            <strong>Carrera:</strong> ${data[5]}<br/>
                            <strong>Matriculados:</strong> ${data[0]}<br/>
                            <strong>Empleabilidad:</strong> ${data[1]}%<br/>
                            <strong>Número de Apariciones:</strong> ${data[2]}<br/>
                            <strong>Número de Iniciativas:</strong> ${data[3]}<br/>
                            <strong>NPS:</strong> ${data[4]}
                        `;
                    }
                },
                xAxis: {
                    name: 'Matriculados',
                    type: 'value'
                },
                yAxis: {
                    name: 'Empleabilidad (%)',
                    type: 'value'
                },
                series: [{
                    symbol: function (data) {
                        var nps = data[4]; // nps es el quinto valor en el array de datos
                        if (nps < 5) {
                            return 'path://M512 960c248.352 0 448-199.648 448-448S760.352 64 512 64 64 263.648 64 512s199.648 448 448 448zm0-64C299.648 896 128 724.352 128 512S299.648 128 512 128s384 171.648 384 384-171.648 384-384 384zm-64-320h128c17.664 0 32 14.336 32 32s-14.336 32-32 32H448c-17.664 0-32-14.336-32-32s14.336-32 32-32zm192-32c0-70.592-57.408-128-128-128s-128 57.408-128 128h-64c0-105.888 86.112-192 192-192s192 86.112 192 192h-64z'; // Cara triste
                        } else if (nps === 5) {
                            return 'path://M512 960c248.352 0 448-199.648 448-448S760.352 64 512 64 64 263.648 64 512s199.648 448 448 448zm0-64C299.648 896 128 724.352 128 512S299.648 128 512 128s384 171.648 384 384-171.648 384-384 384zm-128-320h256c17.664 0 32 14.336 32 32s-14.336 32-32 32H384c-17.664 0-32-14.336-32-32s14.336-32 32-32zm0-128h256c17.664 0 32 14.336 32 32s-14.336 32-32 32H384c-17.664 0-32-14.336-32-32s14.336-32 32-32z'; // Cara neutra
                        } else {
                            return 'path://M512 960c248.352 0 448-199.648 448-448S760.352 64 512 64 64 263.648 64 512s199.648 448 448 448zm0-64C299.648 896 128 724.352 128 512S299.648 128 512 128s384 171.648 384 384-171.648 384-384 384zm0-128c-70.592 0-128-57.408-128-128h-64c0 105.888 86.112 192 192 192s192-86.112 192-192h-64c0 70.592-57.408 128-128 128zm-128-192h256c17.664 0 32 14.336 32 32s-14.336 32-32 32H384c-17.664 0-32-14.336-32-32s14.336-32 32-32z'; // Cara feliz
                        }
                    },
                    symbolSize: function (data) {
                        return data[2]; // El tamaño del punto está basado en el "número de apariciones"
                    },
                    data: yearData,
                    type: 'scatter',
                    itemStyle: {
                        color: function (param) {
                            var n_iniciativas = param.data[3];
                            if (n_iniciativas < 4) {
                                return '#ffcccc'; // Pocos iniciativas - color claro
                            } else if (n_iniciativas < 7) {
                                return '#ff9999'; // Degradado intermedio
                            } else {
                                return '#ff3333'; // Muchas iniciativas - color oscuro
                            }
                        }
                    }
                }]
            };

            // Actualizar el gráfico con la nueva configuración
            chart.setOption(option);
        }

        // Inicializar el gráfico con los datos de todos los años
        updateChart('all');

        // Cambiar el gráfico cuando se selecciona un nuevo año
        document.getElementById('yearSelect').addEventListener('change', function () {
            var selectedYear = this.value;
            updateChart(selectedYear);  // Actualizar gráfico con el año seleccionado
        });
    </script>

</body>
</html>
